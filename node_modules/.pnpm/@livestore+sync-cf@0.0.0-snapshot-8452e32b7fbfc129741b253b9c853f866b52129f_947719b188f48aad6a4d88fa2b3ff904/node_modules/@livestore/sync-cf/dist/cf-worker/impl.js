import { Effect, Stream } from '@livestore/utils/effect';
import { WSMessage } from "../common/mod.js";
import { PULL_CHUNK_SIZE } from "./shared.js";
export const makePull = ({ storage, requestId }) => (req) => Effect.gen(function* () {
    // TODO use streaming
    const remainingEvents = yield* storage.getEvents(req.cursor);
    const batches = (remainingEvents.length === 0
        ? // Send at least one response, even if there are no events
            [[]]
        : Array.from({ length: Math.ceil(remainingEvents.length / PULL_CHUNK_SIZE) }, (_, i) => remainingEvents.slice(i * PULL_CHUNK_SIZE, (i + 1) * PULL_CHUNK_SIZE))).map((batch, i) => WSMessage.PullRes.make({
        batch,
        remaining: Math.max(0, remainingEvents.length - (i + 1) * PULL_CHUNK_SIZE),
        requestId: { context: 'pull', requestId },
    }));
    return Stream.fromIterable(batches);
}).pipe(Stream.unwrap);
//# sourceMappingURL=impl.js.map